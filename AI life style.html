<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Calorie & Macro Tracker (MVP)</title>
<style>
:root{
  --bg:#f7fbff; --card:#ffffff; --ink:#0f172a; --sub:#475569;
  --brand:#2563eb; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
  --muted:#e2e8f0;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:linear-gradient(180deg,#f7fbff,#eef6ff);
  color:var(--ink);
}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{
  background:var(--card); border:1px solid var(--muted);
  box-shadow:0 10px 30px rgba(0,0,0,.05);
  border-radius:18px; padding:16px; margin:12px 0;
}
h1,h2,h3{margin:8px 0}
h1{font-size:clamp(22px,3.8vw,30px)}
h2{font-size:clamp(18px,3.2vw,24px)}
.sub{color:var(--sub)}
.row{display:flex; gap:12px; flex-wrap:wrap}
.col{flex:1 1 260px}
label{display:block; font-weight:600; margin:6px 0}
input,select,button,textarea{
  width:100%; padding:12px; border-radius:12px; border:1px solid var(--muted);
  font-size:16px;
}
button{background:var(--brand); color:#fff; border:none; cursor:pointer; font-weight:700}
button.ghost{background:#CBD5E1; color:#0f172a}
button.warn{background:var(--warn); color:#111}
button.ok{background:var(--ok)}
button.danger{background:var(--danger)}
button:active{transform:scale(.99)}
.toolbar{display:flex; gap:8px; flex-wrap:wrap}
nav{
  display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;
}
nav button{flex:1 1 120px}
.badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2ff}
.small{font-size:13px; color:var(--sub)}
hr{border:none; border-top:1px dashed var(--muted); margin:12px 0}
table{width:100%; border-collapse:collapse}
th,td{border-bottom:1px solid #e5e7eb; padding:8px; text-align:center}
tfoot td{font-weight:800}
.kpi{display:flex; gap:10px; flex-wrap:wrap}
.kpi .card{flex:1 1 200px; text-align:center}
.center{text-align:center}
.hidden{display:none}
.flex{display:flex; gap:8px; align-items:center}
.flex-col{display:flex; gap:8px; flex-direction:column}
progress{width:100%; height:16px}
.tag{display:inline-block;padding:2px 8px;border-radius:8px;background:#e2e8f0;margin:2px;font-size:12px}
.meal-item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;padding:8px;border-radius:12px}
.meal-item strong{flex:1}
.meal-item input{width:90px}
footer{padding:24px 0;color:#64748b;text-align:center}
/* Camera */
.camera{
  background:#0b1220;color:#e2e8f0;border-radius:16px;padding:12px
}
video,canvas{width:100%;border-radius:12px;background:#000}
.pred{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.pred .tag{background:#dbeafe}
/* Wizard steps */
.stepper{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.step{flex:1;height:6px;background:#e2e8f0;border-radius:99px;position:relative}
.step.done{background:#86efac}
.step.active{background:#93c5fd}
/* Water tracker */
.cups{display:flex;gap:6px;flex-wrap:wrap}
.cup{width:44px;height:60px;border:2px solid #60a5fa;border-radius:10px;position:relative;overflow:hidden;cursor:pointer;background:#fff}
.cup.fill::after{content:"";position:absolute;bottom:0;left:0;width:100%;height:70%;background:#93c5fd}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1 id="appTitle">AI Calorie & Macro Tracker</h1>
    <div class="small" id="subtitle">MVP ‚Äî on-device mock AI + manual adjust. Data saved locally.</div>
  </div>

  <nav id="nav" class="card hidden">
    <button data-tab="home">Home</button>
    <button data-tab="goals">Daily Goals</button>
    <button data-tab="camera">Camera</button>
    <button data-tab="log">Food Log</button>
    <button data-tab="water">Water</button>
    <button data-tab="profile">Profile</button>
    <button data-tab="about">About</button>
  </nav>

  <!-- Onboarding Wizard -->
  <div id="wizard" class="card">
    <div class="stepper">
      <div class="step active" id="s1"></div>
      <div class="step" id="s2"></div>
      <div class="step" id="s3"></div>
    </div>
    <div id="step1">
      <h2>Choose Language</h2>
      <div class="row">
        <div class="col">
          <label>Language</label>
          <select id="langSelect">
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="en" selected>English</option>
            <option value="fr">Fran√ßais</option>
            <option value="es">Espa√±ol</option>
            <option value="de">Deutsch</option>
            <option value="it">Italiano</option>
            <option value="pt">Portugu√™s</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="tr">T√ºrk√ße</option>
            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
            <option value="nl">Nederlands</option>
            <option value="sv">Svenska</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button id="next1">Next</button>
      </div>
    </div>

    <div id="step2" class="hidden">
      <h2>Profile</h2>
      <div class="row">
        <div class="col">
          <label>Sex</label>
          <select id="sex">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="col">
          <label>Age (years)</label>
          <input id="age" type="number" min="8" max="100" value="16">
        </div>
        <div class="col">
          <label>Height (cm)</label>
          <input id="height" type="number" min="100" max="230" value="180">
        </div>
        <div class="col">
          <label>Weight (kg)</label>
          <input id="weight" type="number" min="30" max="200" value="75">
        </div>
      </div>
      <div class="toolbar">
        <button class="ghost" id="back2">Back</button>
        <button id="next2">Next</button>
      </div>
    </div>

    <div id="step3" class="hidden">
      <h2>Activity</h2>
      <div class="row">
        <div class="col">
          <label>Workout days/week</label>
          <input id="days" type="number" min="0" max="7" value="3">
        </div>
        <div class="col">
          <label>Goal</label>
          <select id="goal">
            <option value="maintain">Maintain</option>
            <option value="cut">Cut (-15%)</option>
            <option value="bulk">Bulk (+10%)</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button class="ghost" id="back3">Back</button>
        <button id="finish">Finish</button>
      </div>
    </div>
  </div>

  <!-- Home / Dashboard -->
  <div id="home" class="card hidden">
    <h2 id="dashTitle">Dashboard</h2>
    <div class="kpi">
      <div class="card">
        <div class="small">Calories Today</div>
        <div id="kcalToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="kcalTarget">0</span></div>
        <progress id="kcalProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Protein (g)</div>
        <div id="protToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="protTarget">0</span></div>
        <progress id="protProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Fat (g)</div>
        <div id="fatToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="fatTarget">0</span></div>
        <progress id="fatProg" max="100" value="0"></progress>
      </div>
      <div class="card">
        <div class="small">Carbs (g)</div>
        <div id="carbToday" style="font-size:28px;font-weight:800">0</div>
        <div class="small">Target: <span id="carbTarget">0</span></div>
        <progress id="carbProg" max="100" value="0"></progress>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="badge">Streak: <span id="streak">0</span> üî•</div>
      </div>
      <div class="col center">
        <button id="toCamera">Open Camera</button>
      </div>
      <div class="col center">
        <button class="ghost" id="toLog">Open Food Log</button>
      </div>
    </div>
  </div>

  <!-- Goals -->
  <div id="goals" class="card hidden">
    <h2>Daily Goals</h2>
    <div class="row">
      <div class="col"><label>Calories</label><input id="g_kcal" type="number"></div>
      <div class="col"><label>Protein (g)</label><input id="g_prot" type="number"></div>
      <div class="col"><label>Fat (g)</label><input id="g_fat" type="number"></div>
      <div class="col"><label>Carbs (g)</label><input id="g_carb" type="number"></div>
    </div>
    <div class="toolbar">
      <button id="saveGoals" class="ok">Save</button>
      <button id="recalcGoals" class="ghost">Recalculate from Profile</button>
    </div>
  </div>

  <!-- Camera Page -->
  <div id="camera" class="card hidden">
    <h2>Camera (Beta)</h2>
    <div class="camera">
      <video id="vid" autoplay playsinline muted></video>
      <div class="toolbar">
        <button id="startCam">Start Camera</button>
        <button id="snap" class="ghost">Capture</button>
        <button id="classify" class="ok">AI Guess</button>
      </div>
      <canvas id="frame" class="hidden"></canvas>
      <div class="pred" id="pred"></div>
    </div>
    <hr>
    <h3>Add to Meal</h3>
    <div class="row">
      <div class="col">
        <label>Food</label>
        <input id="foodSearch" placeholder="Search or pick AI guess...">
        <div class="small">Examples: rice, chicken breast, apple, pizza</div>
      </div>
      <div class="col">
        <label>Portion (g)</label>
        <input id="portion" type="number" value="150">
      </div>
      <div class="col">
        <label>Meal</label>
        <select id="mealType">
          <option>Breakfast</option>
          <option>Lunch</option>
          <option>Dinner</option>
          <option>Snack</option>
        </select>
      </div>
    </div>
    <div class="toolbar">
      <button id="addMeal">Add to Log</button>
    </div>
  </div>

  <!-- Log -->
  <div id="log" class="card hidden">
    <h2>Food Log ‚Äî <span id="logDate"></span></h2>
    <div id="logItems"></div>
    <hr>
    <table>
      <thead><tr><th>Meal</th><th>Food</th><th>g</th><th>kcal</th><th>P</th><th>F</th><th>C</th><th></th></tr></thead>
      <tbody id="logTable"></tbody>
      <tfoot><tr><td colspan="3">Totals</td><td id="tKcal">0</td><td id="tP">0</td><td id="tF">0</td><td id="tC">0</td><td></td></tr></tfoot>
    </table>
    <div class="toolbar">
      <button id="clearToday" class="danger">Clear Today</button>
    </div>
  </div>

  <!-- Water -->
  <div id="water" class="card hidden">
    <h2>Water Tracker</h2>
    <div class="row">
      <div class="col">
        <label>Daily target (ml)</label>
        <input id="waterTarget" type="number" value="2500">
        <div class="small">Tip: ~35 ml per kg</div>
      </div>
      <div class="col">
        <label>Cup size (ml)</label>
        <input id="cupSize" type="number" value="250">
      </div>
    </div>
    <div class="toolbar">
      <button id="saveWater" class="ok">Save</button>
      <button id="drink">Drink 1 cup</button>
      <button id="resetWater" class="ghost">Reset Today</button>
    </div>
    <div class="row">
      <div class="col">
        <div>Progress: <span id="waterProgTxt">0 / 0 ml</span></div>
        <progress id="waterProg" max="100" value="0"></progress>
      </div>
    </div>
    <div class="cups" id="cups"></div>
  </div>

  <!-- Profile -->
  <div id="profile" class="card hidden">
    <h2>Profile</h2>
    <div id="profSummary"></div>
    <div class="toolbar"><button id="restart" class="warn">Restart Wizard</button></div>
  </div>

  <!-- About -->
  <div id="about" class="card hidden">
    <h2>About</h2>
    <p>This MVP runs fully in your browser. AI detection uses a generic MobileNet image classifier (best-effort). Always adjust items/portions manually for accuracy.</p>
    <p>Data is stored locally (this device only).</p>
  </div>

  <footer>¬© 2025 ‚Äî MVP built for you. </footer>
</div>

<!-- TF.js & MobileNet -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

<script>
// ====== Simple i18n ======
const I18N = {
  en:{title:"AI Calorie & Macro Tracker", next:"Next", back:"Back", finish:"Finish", home:"Home", goals:"Daily Goals", camera:"Camera", log:"Food Log", water:"Water", profile:"Profile", about:"About"},
  ar:{title:"ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿπÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿßŸÉÿ±Ÿàÿ≤ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä", next:"ÿßŸÑÿ™ÿßŸÑŸä", back:"ÿ±ÿ¨Ÿàÿπ", finish:"ÿ•ŸÜŸáÿßÿ°", home:"ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©", goals:"ÿßŸÑÿ£ŸáÿØÿßŸÅ ÿßŸÑŸäŸàŸÖŸäÿ©", camera:"ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß", log:"ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÉŸÑ", water:"ÿßŸÑŸÖÿßÿ°", profile:"ÿßŸÑŸÖŸÑŸÅ", about:"ÿπŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"},
  fr:{title:"Suivi Calories & Macros IA", next:"Suivant", back:"Retour", finish:"Terminer", home:"Accueil", goals:"Objectifs", camera:"Cam√©ra", log:"Journal", water:"Eau", profile:"Profil", about:"√Ä propos"},
  es:{title:"Contador de Calor√≠as y Macros IA", next:"Siguiente", back:"Atr√°s", finish:"Finalizar", home:"Inicio", goals:"Objetivos", camera:"C√°mara", log:"Registro", water:"Agua", profile:"Perfil", about:"Acerca de"},
  de:{title:"Kalorien- & Makro-Tracker KI", next:"Weiter", back:"Zur√ºck", finish:"Fertig", home:"Start", goals:"Ziele", camera:"Kamera", log:"Tagebuch", water:"Wasser", profile:"Profil", about:"Info"},
  it:{title:"Tracker Calorie & Macro IA", next:"Avanti", back:"Indietro", finish:"Fine", home:"Home", goals:"Obiettivi", camera:"Fotocamera", log:"Registro", water:"Acqua", profile:"Profilo", about:"Info"},
  pt:{title:"Rastreador de Calorias e Macros IA", next:"Pr√≥ximo", back:"Voltar", finish:"Concluir", home:"In√≠cio", goals:"Metas", camera:"C√¢mera", log:"Registro", water:"√Ågua", profile:"Perfil", about:"Sobre"},
  ru:{title:"–ò–ò –¢—Ä–µ–∫–µ—Ä –ö–∞–ª–æ—Ä–∏–π –∏ –ú–∞–∫—Ä–æ—Å–æ–≤", next:"–î–∞–ª–µ–µ", back:"–ù–∞–∑–∞–¥", finish:"–ì–æ—Ç–æ–≤–æ", home:"–ì–ª–∞–≤–Ω–∞—è", goals:"–¶–µ–ª–∏", camera:"–ö–∞–º–µ—Ä–∞", log:"–î–Ω–µ–≤–Ω–∏–∫", water:"–í–æ–¥–∞", profile:"–ü—Ä–æ—Ñ–∏–ª—å", about:"–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏"},
  tr:{title:"YZ Kalori & Makro Takip", next:"ƒ∞leri", back:"Geri", finish:"Bitir", home:"Ana Sayfa", goals:"Hedefler", camera:"Kamera", log:"Kayƒ±t", water:"Su", profile:"Profil", about:"Hakkƒ±nda"},
  hi:{title:"‡§è‡§Ü‡§à ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä ‡§µ ‡§Æ‡•à‡§ï‡•ç‡§∞‡•ã‡§ú‡§º ‡§ü‡•ç‡§∞‡•à‡§ï‡§∞", next:"‡§Ö‡§ó‡§≤‡§æ", back:"‡§µ‡§æ‡§™‡§∏", finish:"‡§∏‡§Æ‡§æ‡§™‡•ç‡§§", home:"‡§π‡•ã‡§Æ", goals:"‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø", camera:"‡§ï‡•à‡§Æ‡§∞‡§æ", log:"‡§≤‡•â‡§ó", water:"‡§™‡§æ‡§®‡•Ä", profile:"‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤", about:"‡§™‡§∞‡§ø‡§ö‡§Ø"},
  zh:{title:"AI ÁÉ≠Èáè‰∏éËê•ÂÖªÁ¥†ËøΩË∏™", next:"‰∏ã‰∏ÄÊ≠•", back:"ËøîÂõû", finish:"ÂÆåÊàê", home:"È¶ñÈ°µ", goals:"ÁõÆÊ†á", camera:"Áõ∏Êú∫", log:"ËÆ∞ÂΩï", water:"È•ÆÊ∞¥", profile:"ËµÑÊñô", about:"ÂÖ≥‰∫é"},
  ja:{title:"AI „Ç´„É≠„É™„Éº&„Éû„ÇØ„É≠ÁÆ°ÁêÜ", next:"Ê¨°„Å∏", back:"Êàª„Çã", finish:"ÂÆå‰∫Ü", home:"„Éõ„Éº„É†", goals:"ÁõÆÊ®ô", camera:"„Ç´„É°„É©", log:"„É≠„Ç∞", water:"Ê∞¥ÂàÜ", profile:"„Éó„É≠„Éï„Ç£„Éº„É´", about:"Ê¶ÇË¶Å"},
  ko:{title:"AI ÏπºÎ°úÎ¶¨¬∑Îß§ÌÅ¨Î°ú Ìä∏ÎûòÏª§", next:"Îã§Ïùå", back:"Îí§Î°ú", finish:"ÏôÑÎ£å", home:"Ìôà", goals:"Î™©Ìëú", camera:"Ïπ¥Î©îÎùº", log:"Í∏∞Î°ù", water:"Î¨º", profile:"ÌîÑÎ°úÌïÑ", about:"ÏÜåÍ∞ú"},
  nl:{title:"AI Calorie- & Macrotracker", next:"Volgende", back:"Terug", finish:"Voltooien", home:"Home", goals:"Doelen", camera:"Camera", log:"Logboek", water:"Water", profile:"Profiel", about:"Over"},
  sv:{title:"AI Kalori- & Makrosp√•rare", next:"N√§sta", back:"Tillbaka", finish:"Klart", home:"Hem", goals:"M√•l", camera:"Kamera", log:"Logg", water:"Vatten", profile:"Profil", about:"Om"}
};
let LANG = 'ar';

function setLang(k){
  LANG = k; const T = I18N[k]||I18N.en;
  document.getElementById('appTitle').textContent = T.title;
  // nav
  const nav = document.getElementById('nav'); nav.querySelectorAll('button').forEach(b=>{
    const key = b.dataset.tab;
    b.textContent = T[key] || b.textContent;
  });
  // dir
  document.documentElement.dir = (k==='ar') ? 'rtl' : 'ltr';
}

// ====== State & Storage ======
const SKEY = 'mvp_tracker_state_v1';
let state = JSON.parse(localStorage.getItem(SKEY)||'{}');
function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }

// ====== Wizard logic ======
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
function markSteps(a,b,c){
  document.getElementById('s1').className='step'+(a?' active done':'');
  document.getElementById('s2').className='step'+(b?' active done':'');
  document.getElementById('s3').className='step'+(c?' active done':'');
}
document.getElementById('next1').onclick = ()=>{
  const lang = document.getElementById('langSelect').value; setLang(lang);
  state.lang = lang; save();
  step1.classList.add('hidden'); step2.classList.remove('hidden'); markSteps(false,true,false);
}
document.getElementById('back2').onclick = ()=>{ step2.classList.add('hidden'); step1.classList.remove('hidden'); markSteps(true,false,false); }
document.getElementById('next2').onclick = ()=>{
  state.sex = document.getElementById('sex').value;
  state.age = +document.getElementById('age').value;
  state.height = +document.getElementById('height').value;
  state.weight = +document.getElementById('weight').value;
  save();
  step2.classList.add('hidden'); step3.classList.remove('hidden'); markSteps(false,false,true);
}
document.getElementById('back3').onclick = ()=>{ step3.classList.add('hidden'); step2.classList.remove('hidden'); markSteps(false,true,false); }
document.getElementById('finish').onclick = ()=>{
  state.days = +document.getElementById('days').value;
  state.goal = document.getElementById('goal').value;
  calcGoalsFromProfile();
  save();
  document.getElementById('wizard').classList.add('hidden');
  document.getElementById('nav').classList.remove('hidden');
  showTab('home');
}

// ====== Tabs ======
const tabs = ['home','goals','camera','log','water','profile','about'];
document.getElementById('nav').addEventListener('click', (e)=>{
  if(e.target.tagName!=='BUTTON') return;
  showTab(e.target.dataset.tab);
});
function showTab(id){
  tabs.forEach(t=>document.getElementById(t).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='home') refreshDashboard();
  if(id==='log') refreshLog();
  if(id==='water') refreshWaterUI();
  if(id==='profile') renderProfile();
}
document.getElementById('toCamera').onclick=()=>showTab('camera');
document.getElementById('toLog').onclick=()=>showTab('log');

// ====== Calculations ======
function activityFactor(days){
  if(days<=0) return 1.2;
  if(days<=2) return 1.375;
  if(days<=4) return 1.55;
  if(days<=6) return 1.725;
  return 1.9;
}
function calcTDEE(){
  const w=state.weight||70, h=state.height||175, a=state.age||25, s=state.sex||'male', d=state.days||3;
  const bmr = (s==='male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161);
  let tdee = bmr * activityFactor(d);
  if(state.goal==='cut') tdee *= 0.85;
  if(state.goal==='bulk') tdee *= 1.10;
  return Math.round(tdee);
}
function calcMacros(){
  const kcal = calcTDEE();
  const prot = Math.round((state.weight||70) * 1.8); // g
  const fat = Math.round((state.weight||70) * 0.9); // g
  let restK = kcal - (prot*4 + fat*9);
  const carb = Math.max(0, Math.round(restK/4));
  return {kcal, prot, fat, carb};
}
function calcGoalsFromProfile(){
  const m = calcMacros();
  state.goals = m; save();
  fillGoals();
}

// ====== Goals UI ======
function fillGoals(){
  const g = state.goals || calcMacros();
  ['kcal','prot','fat','carb'].forEach(k=>{
    document.getElementById('g_'+k).value = g[k];
  });
  refreshDashboard();
}
document.getElementById('saveGoals').onclick = ()=>{
  state.goals = {
    kcal:+document.getElementById('g_kcal').value,
    prot:+document.getElementById('g_prot').value,
    fat:+document.getElementById('g_fat').value,
    carb:+document.getElementById('g_carb').value
  };
  save(); refreshDashboard();
};
document.getElementById('recalcGoals').onclick = ()=>{ calcGoalsFromProfile(); };

// ====== Dashboard ======
function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
function getDay(day=todayKey()){ state.daysData = state.daysData||{}; return (state.daysData[day]=state.daysData[day]||{meals:[], water:0}); }
function sumDay(day=todayKey()){
  const obj = getDay(day);
  return obj.meals.reduce((acc,m)=>{
    acc.kcal += m.kcal; acc.prot += m.prot; acc.fat += m.fat; acc.carb += m.carb; return acc;
  }, {kcal:0,prot:0,fat:0,carb:0});
}
function refreshDashboard(){
  const g = state.goals || calcMacros();
  const s = sumDay();
  document.getElementById('kcalToday').textContent = Math.round(s.kcal);
  document.getElementById('protToday').textContent = Math.round(s.prot);
  document.getElementById('fatToday').textContent = Math.round(s.fat);
  document.getElementById('carbToday').textContent = Math.round(s.carb);
  document.getElementById('kcalTarget').textContent = g.kcal;
  document.getElementById('protTarget').textContent = g.prot;
  document.getElementById('fatTarget').textContent = g.fat;
  document.getElementById('carbTarget').textContent = g.carb;
  document.getElementById('kcalProg').value = Math.min(100, (s.kcal/g.kcal)*100);
  document.getElementById('protProg').value = Math.min(100, (s.prot/g.prot)*100);
  document.getElementById('fatProg').value = Math.min(100, (s.fat/g.fat)*100);
  document.getElementById('carbProg').value = Math.min(100, (s.carb/g.carb)*100);
  updateStreak();
}

// ====== Foods DB (starter ~70) per 100g ======
const FOODS = [
{name:"white rice", ar:"ÿ±ÿ≤ ÿ£ÿ®Ÿäÿ∂ ŸÖÿ∑ÿ®ŸàÿÆ", kcal:130, prot:2.4, fat:0.3, carb:28.7},
{name:"brown rice", ar:"ÿ±ÿ≤ ÿ®ŸÜŸä", kcal:123, prot:2.7, fat:1.0, carb:25.6},
{name:"grilled chicken breast", ar:"ÿµÿØÿ± ÿØÿ¨ÿßÿ¨ ŸÖÿ¥ŸàŸä", kcal:165, prot:31, fat:3.6, carb:0},
{name:"beef steak lean", ar:"ÿ≥ÿ™ŸäŸÉ ÿ®ŸÇÿ±Ÿä ŸÇŸÑŸäŸÑ ÿßŸÑÿØŸáŸÜ", kcal:187, prot:27, fat:8, carb:0},
{name:"ground beef 80/20", ar:"ŸÑÿ≠ŸÖÿ© ŸÖŸÅÿ±ŸàŸÖÿ© 20% ÿØŸáŸÜ", kcal:254, prot:17, fat:20, carb:0},
{name:"lamb", ar:"ŸÑÿ≠ŸÖ ÿ∂ÿ£ŸÜ", kcal:258, prot:25, fat:17, carb:0},
{name:"salmon", ar:"ÿ≥ÿßŸÑŸÖŸàŸÜ", kcal:208, prot:20, fat:13, carb:0},
{name:"tuna canned water", ar:"ÿ™ŸàŸÜÿ© ŸÖÿπŸÑÿ®ÿ©", kcal:132, prot:29, fat:1, carb:0},
{name:"eggs", ar:"ÿ®Ÿäÿ∂", kcal:155, prot:13, fat:11, carb:1.1},
{name:"egg whites", ar:"ÿ®Ÿäÿßÿ∂ ÿ®Ÿäÿ∂", kcal:52, prot:11, fat:0.2, carb:0.7},
{name:"whole milk", ar:"ÿ≠ŸÑŸäÿ® ŸÉÿßŸÖŸÑ ÿßŸÑÿØÿ≥ŸÖ", kcal:61, prot:3.2, fat:3.3, carb:4.8},
{name:"yogurt plain", ar:"ÿ≤ÿ®ÿßÿØŸä ÿ≥ÿßÿØÿ©", kcal:59, prot:10, fat:0.4, carb:3.6},
{name:"cheddar cheese", ar:"ÿ¨ÿ®ŸÜÿ© ÿ¥ŸäÿØÿ±", kcal:403, prot:25, fat:33, carb:1.3},
{name:"olive oil", ar:"ÿ≤Ÿäÿ™ ÿ≤Ÿäÿ™ŸàŸÜ", kcal:884, prot:0, fat:100, carb:0},
{name:"bread white", ar:"ÿÆÿ®ÿ≤ ÿ£ÿ®Ÿäÿ∂", kcal:265, prot:9, fat:3.2, carb:49},
{name:"bread whole wheat", ar:"ÿÆÿ®ÿ≤ ŸÇŸÖÿ≠ ŸÉÿßŸÖŸÑ", kcal:247, prot:12, fat:3.4, carb:41},
{name:"pasta cooked", ar:"ŸÖŸÉÿ±ŸàŸÜÿ© ŸÖÿ∑ÿ®ŸàÿÆÿ©", kcal:131, prot:5, fat:1.1, carb:25},
{name:"oats dry", ar:"ÿ¥ŸàŸÅÿßŸÜ", kcal:389, prot:17, fat:7, carb:66},
{name:"banana", ar:"ŸÖŸàÿ≤", kcal:89, prot:1.1, fat:0.3, carb:23},
{name:"apple", ar:"ÿ™ŸÅÿßÿ≠", kcal:52, prot:0.3, fat:0.2, carb:14},
{name:"orange", ar:"ÿ®ÿ±ÿ™ŸÇÿßŸÑ", kcal:47, prot:0.9, fat:0.1, carb:12},
{name:"dates", ar:"ÿ®ŸÑÿ≠", kcal:282, prot:2.5, fat:0.4, carb:75},
{name:"potato boiled", ar:"ÿ®ÿ∑ÿßÿ∑ÿ≥ ŸÖÿ≥ŸÑŸàŸÇÿ©", kcal:87, prot:1.9, fat:0.1, carb:20},
{name:"sweet potato", ar:"ÿ®ÿ∑ÿßÿ∑ÿß", kcal:86, prot:1.6, fat:0.1, carb:20},
{name:"broccoli", ar:"ÿ®ÿ±ŸàŸÉŸÑŸä", kcal:34, prot:2.8, fat:0.4, carb:7},
{name:"cucumber", ar:"ÿÆŸäÿßÿ±", kcal:16, prot:0.7, fat:0.1, carb:3.6},
{name:"tomato", ar:"ÿ∑ŸÖÿßÿ∑ŸÖ", kcal:18, prot:0.9, fat:0.2, carb:3.9},
{name:"lettuce", ar:"ÿÆÿ≥", kcal:15, prot:1.4, fat:0.2, carb:2.9},
{name:"chickpeas boiled", ar:"ÿ≠ŸÖÿµ ŸÖÿ≥ŸÑŸàŸÇ", kcal:164, prot:9, fat:2.6, carb:27},
{name:"beans fava cooked", ar:"ŸÅŸàŸÑ", kcal:110, prot:7.6, fat:0.4, carb:19.7},
{name:"hummus dip", ar:"ÿ≠ŸÖÿµ ÿ®ÿ∑ÿ≠ŸäŸÜÿ©", kcal:166, prot:8, fat:9.6, carb:14},
{name:"tahini", ar:"ÿ∑ÿ≠ŸäŸÜÿ©", kcal:595, prot:17, fat:53, carb:21},
{name:"peanut butter", ar:"ÿ≤ÿ®ÿØÿ© ŸÅŸàŸÑ ÿ≥ŸàÿØÿßŸÜŸä", kcal:588, prot:25, fat:50, carb:20},
{name:"almonds", ar:"ŸÑŸàÿ≤", kcal:579, prot:21, fat:50, carb:22},
{name:"walnuts", ar:"ÿ¨Ÿàÿ≤", kcal:654, prot:15, fat:65, carb:14},
{name:"white fish", ar:"ÿ≥ŸÖŸÉ ÿ£ÿ®Ÿäÿ∂", kcal:96, prot:20, fat:1.5, carb:0},
{name:"shrimp", ar:"ÿ¨ŸÖÿ®ÿ±Ÿä", kcal:99, prot:24, fat:0.3, carb:0.2},
{name:"pizza margherita", ar:"ÿ®Ÿäÿ™ÿ≤ÿß", kcal:266, prot:11, fat:10, carb:33},
{name:"shawarma chicken", ar:"ÿ¥ÿßŸàÿ±ŸÖÿß ÿØÿ¨ÿßÿ¨", kcal:215, prot:18, fat:10, carb:15},
{name:"kofta", ar:"ŸÉŸÅÿ™ÿ©", kcal:250, prot:18, fat:18, carb:5},
{name:"koshary", ar:"ŸÉÿ¥ÿ±Ÿä", kcal:164, prot:5, fat:3, carb:30},
{name:"molokhia", ar:"ŸÖŸÑŸàÿÆŸäÿ©", kcal:36, prot:3, fat:1, carb:6},
{name:"falafel", ar:"ÿ∑ÿπŸÖŸäÿ©", kcal:333, prot:13, fat:17, carb:31},
{name:"foul medames", ar:"ŸÅŸàŸÑ ŸÖÿØŸÖÿ≥", kcal:110, prot:7.6, fat:0.4, carb:19.7},
{name:"rice pudding", ar:"ÿ±ÿ≤ ÿ®ŸÑÿ®ŸÜ", kcal:118, prot:3.6, fat:2.6, carb:20},
{name:"baklava", ar:"ÿ®ŸÇŸÑÿßŸàÿ©", kcal:430, prot:6, fat:27, carb:42},
{name:"ice cream", ar:"ÿ¢Ÿäÿ≥ ŸÉÿ±ŸäŸÖ", kcal:207, prot:3.5, fat:11, carb:24},
{name:"dark chocolate 70%", ar:"ÿ¥ŸàŸÉŸàŸÑÿßÿ™ÿ© ÿØÿßŸÉŸÜÿ©", kcal:600, prot:7.8, fat:43, carb:46},
{name:"coke regular", ar:"ŸÖÿ¥ÿ±Ÿàÿ® ÿ∫ÿßÿ≤Ÿä", kcal:42, prot:0, fat:0, carb:10.6},
{name:"orange juice", ar:"ÿπÿµŸäÿ± ÿ®ÿ±ÿ™ŸÇÿßŸÑ", kcal:45, prot:0.7, fat:0.2, carb:10.4},
{name:"protein powder whey", ar:"ÿ®ÿ±Ÿàÿ™ŸäŸÜ ŸàÿßŸä", kcal:400, prot:80, fat:7, carb:8},
{name:"lentils cooked", ar:"ÿπÿØÿ≥ ŸÖÿ∑ÿ®ŸàÿÆ", kcal:116, prot:9, fat:0.4, carb:20},
{name:"quinoa cooked", ar:"ŸÉŸäŸÜŸàÿß ŸÖÿ∑ÿ®ŸàÿÆÿ©", kcal:120, prot:4.4, fat:1.9, carb:21.3},
{name:"bulgur cooked", ar:"ÿ®ÿ±ÿ∫ŸÑ ŸÖÿ∑ÿ®ŸàÿÆ", kcal:83, prot:3.1, fat:0.2, carb:18.6},
{name:"couscous cooked", ar:"ŸÉÿ≥ŸÉÿ≥Ÿä ŸÖÿ∑ÿ®ŸàÿÆ", kcal:112, prot:3.8, fat:0.2, carb:23},
{name:"beef liver", ar:"ŸÉÿ®ÿØÿ© ÿ®ŸÇÿ±Ÿä", kcal:135, prot:20, fat:4, carb:4},
{name:"chicken liver", ar:"ŸÉÿ®ÿØÿ© ÿØÿ¨ÿßÿ¨", kcal:172, prot:25, fat:6, carb:1},
{name:"tahini salad", ar:"ÿ≥ŸÑÿ∑ÿ© ÿ∑ÿ≠ŸäŸÜÿ©", kcal:220, prot:6, fat:19, carb:8},
{name:"feta cheese", ar:"ÿ¨ÿ®ŸÜÿ© ŸÅŸäÿ™ÿß", kcal:264, prot:14, fat:21, carb:4},
{name:"halloumi", ar:"ÿ≠ŸÑŸàŸÖŸä", kcal:321, prot:22, fat:26, carb:2},
{name:"manakish zaatar", ar:"ŸÖŸÜÿßŸÇŸäÿ¥ ÿ≤ÿπÿ™ÿ±", kcal:300, prot:9, fat:13, carb:38},
{name:"sushi (avg)", ar:"ÿ≥Ÿàÿ¥Ÿä", kcal:145, prot:9, fat:4, carb:20},
{name:"burger patty beef", ar:"ÿ®ÿ±ÿ¨ÿ± ÿ®ŸÇÿ±Ÿä", kcal:250, prot:17, fat:20, carb:0},
{name:"fries", ar:"ÿ®ÿ∑ÿßÿ∑ÿ≥ ŸÖŸÇŸÑŸäÿ©", kcal:312, prot:3.4, fat:15, carb:41},
{name:"white pita", ar:"ÿπŸäÿ¥ ÿ®ŸÑÿØŸä", kcal:275, prot:9, fat:1.2, carb:55}
];

// Quick search
function findFood(q){
  q = q.toLowerCase().trim();
  let best = FOODS.find(f=>f.name.includes(q)) || FOODS.find(f=>f.ar.includes(q)) || null;
  return best;
}

// ====== Camera + MobileNet ======
let net = null;
async function loadNet(){
  if(!net){ net = await mobilenet.load(); }
}
async function startCam(){
  const v = document.getElementById('vid');
  const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  v.srcObject = s;
}
document.getElementById('startCam').onclick = startCam;
document.getElementById('snap').onclick = ()=>{
  const v=document.getElementById('vid'), c=document.getElementById('frame');
  c.width = v.videoWidth; c.height = v.videoHeight; c.getContext('2d').drawImage(v,0,0);
  c.classList.remove('hidden');
};
document.getElementById('classify').onclick = async ()=>{
  await loadNet();
  const c=document.getElementById('frame');
  const predDiv=document.getElementById('pred');
  if(c.classList.contains('hidden')){ alert('Capture first'); return; }
  const preds = await net.classify(c);
  predDiv.innerHTML = '';
  preds.slice(0,5).forEach(p=>{
    const tag=document.createElement('span'); tag.className='tag';
    tag.textContent = `${p.className} (${(p.probability*100).toFixed(1)}%)`;
    tag.onclick = ()=>{
      // try map className to our food DB
      const key = p.className.split(',')[0].toLowerCase();
      const guess = findFood(key.split(' ').slice(-1)[0]) || findFood(key) || FOODS[0];
      document.getElementById('foodSearch').value = guess.name;
    };
    predDiv.appendChild(tag);
  });
};

// ====== Add Meal ======
function computeFromFood(f, grams){
  const ratio = grams/100;
  return {
    kcal: +(f.kcal*ratio).toFixed(1),
    prot: +(f.prot*ratio).toFixed(1),
    fat: +(f.fat*ratio).toFixed(1),
    carb: +(f.carb*ratio).toFixed(1)
  };
}
document.getElementById('addMeal').onclick = ()=>{
  const q = document.getElementById('foodSearch').value.trim();
  const grams = +document.getElementById('portion').value;
  const meal = document.getElementById('mealType').value;
  if(!q || grams<=0) return alert('Enter food & portion');
  const f = findFood(q) || FOODS.find(x=>x.name===q) || {name:q, ar:q, kcal:0, prot:0, fat:0, carb:0};
  const val = computeFromFood(f, grams);
  const entry = {date:todayKey(), meal, name:f.name, grams, ...val};
  getDay().meals.push(entry);
  save(); refreshLog(); refreshDashboard();
  document.getElementById('foodSearch').value='';
};

function refreshLog(){
  document.getElementById('logDate').textContent = todayKey();
  const tbody = document.getElementById('logTable'); tbody.innerHTML='';
  const day = getDay();
  let s = {kcal:0,prot:0,fat:0,carb:0};
  day.meals.forEach((m,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.meal}</td><td>${m.name}</td><td>${m.grams}</td>
                    <td>${m.kcal}</td><td>${m.prot}</td><td>${m.fat}</td><td>${m.carb}</td>
                    <td><button data-i="${i}" class="danger">X</button></td>`;
    tbody.appendChild(tr);
    s.kcal+=m.kcal; s.prot+=m.prot; s.fat+=m.fat; s.carb+=m.carb;
  });
  document.getElementById('tKcal').textContent = Math.round(s.kcal);
  document.getElementById('tP').textContent = Math.round(s.prot);
  document.getElementById('tF').textContent = Math.round(s.fat);
  document.getElementById('tC').textContent = Math.round(s.carb);
  tbody.querySelectorAll('button.danger').forEach(b=>b.onclick=()=>{
    const idx = +b.dataset.i; day.meals.splice(idx,1); save(); refreshLog(); refreshDashboard();
  });
}
document.getElementById('clearToday').onclick = ()=>{ getDay().meals = []; save(); refreshLog(); refreshDashboard(); };

// ====== Water ======
function refreshWaterUI(){
  const d = getDay();
  const target = state.waterTarget || Math.round((state.weight||70)*35); // 35 ml/kg
  const cup = state.cupSize || 250;
  const cups = Math.max(1, Math.round(target/cup));
  const cont = document.getElementById('cups'); cont.innerHTML = '';
  for(let i=0;i<cups;i++){
    const el = document.createElement('div'); el.className = 'cup'+(i<Math.floor(d.water/cup)?' fill':'');
    el.onclick = ()=>{ d.water = Math.min(target, d.water+cup); save(); refreshWaterUI(); refreshDashboard(); };
    cont.appendChild(el);
  }
  document.getElementById('waterProgTxt').textContent = `${d.water} / ${target} ml`;
  document.getElementById('waterProg').value = Math.min(100, (d.water/target)*100);
  document.getElementById('waterTarget').value = target;
  document.getElementById('cupSize').value = cup;
}
document.getElementById('saveWater').onclick = ()=>{
  state.waterTarget = +document.getElementById('waterTarget').value;
  state.cupSize = +document.getElementById('cupSize').value;
  save(); refreshWaterUI();
};
document.getElementById('drink').onclick = ()=>{ const d=getDay(); d.water += (state.cupSize||250); save(); refreshWaterUI(); };
document.getElementById('resetWater').onclick = ()=>{ const d=getDay(); d.water=0; save(); refreshWaterUI(); };

// ====== Streak ======
function updateStreak(){
  const g = state.goals || calcMacros();
  const s = sumDay();
  const waterOk = getDay().water >= (state.waterTarget || Math.round((state.weight||70)*35))*0.9;
  const kcalOk = Math.abs(s.kcal - g.kcal) <= g.kcal*0.1; // within 10%
  const protOk = s.prot >= g.prot*0.9;
  const hit = waterOk && kcalOk && protOk;
  const key = 'streakData';
  state.streaks = state.streaks || {last: null, count:0};
  const today = todayKey();
  if(state.streaks.last !== today){
    // only update on first check of the day if previous day was hit
    const yesterday = new Date(Date.now()-86400000).toISOString().slice(0,10);
    const wasCont = state.streaks.last === yesterday && state.streaks.hit;
    state.streaks.count = wasCont ? state.streaks.count : state.streaks.count;
    state.streaks.last = today;
  }
  state.streaks.hit = hit;
  // recompute count over history (simple: if today hit, ensure count>=1 and increment if yesterday cont)
  if(hit){
    const yesterday = new Date(Date.now()-86400000).toISOString().slice(0,10);
    if(state.streaks.prevDay === yesterday){ state.streaks.count = (state.streaks.count||0) + 1; }
    else { state.streaks.count = Math.max(1, state.streaks.count||0); }
    state.streaks.prevDay = today;
  }
  document.getElementById('streak').textContent = state.streaks.count||0;
  save();
}

// ====== Profile summary ======
function renderProfile(){
  const g = state.goals || calcMacros();
  document.getElementById('profSummary').innerHTML = `
    <div class="row">
      <div class="col"><div class="card"><strong>Sex:</strong> ${state.sex||'-'}</div></div>
      <div class="col"><div class="card"><strong>Age:</strong> ${state.age||'-'}</div></div>
      <div class="col"><div class="card"><strong>Height:</strong> ${state.height||'-'} cm</div></div>
      <div class="col"><div class="card"><strong>Weight:</strong> ${state.weight||'-'} kg</div></div>
    </div>
    <div class="row">
      <div class="col"><div class="card"><strong>Days/week:</strong> ${state.days||0}</div></div>
      <div class="col"><div class="card"><strong>Goal:</strong> ${state.goal||'maintain'}</div></div>
      <div class="col"><div class="card"><strong>TDEE:</strong> ${g.kcal} kcal</div></div>
      <div class="col"><div class="card"><strong>Macros (g):</strong> P ${g.prot} / F ${g.fat} / C ${g.carb}</div></div>
    </div>
  `;
}
document.getElementById('restart').onclick = ()=>{
  document.getElementById('wizard').classList.remove('hidden');
  document.getElementById('nav').classList.add('hidden');
};

// ====== Boot ======
(function init(){
  setLang(state.lang||'ar');
  if(state.sex){ // already onboarded
    document.getElementById('wizard').classList.add('hidden');
    document.getElementById('nav').classList.remove('hidden');
    fillGoals(); showTab('home');
  } else {
    // start wizard
    document.getElementById('wizard').classList.remove('hidden');
  }
})();

// ====== Simple search-as-you-type (foodSearch) ======
const fs = document.getElementById('foodSearch');
fs.addEventListener('input', ()=>{
  const val = fs.value.trim().toLowerCase();
  if(!val){ fs.setAttribute('list',''); return; }
});
</script>
</body>
</html>
